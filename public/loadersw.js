const DB_NAME="gm loader db",DB_VER=1,STORE_NAME="gms",gmCcahe=new Map;async function openDB(){return new Promise(((t,e)=>{const s=indexedDB.open(DB_NAME,DB_VER);s.onsuccess=()=>t(s.result),s.onerror=()=>e(s.error)}))}async function getGms(t){if(gmCcahe.has(t))return gmCcahe.get(t);const e=await openDB();return new Promise(((s,n)=>{const o=e.transaction(["gms"],"readonly").objectStore("gms").get(t);o.onsuccess=()=>{const e=o.result;e&&gmCcahe.set(t,e),s(e)},o.onerror=()=>n(o.error)}))}function b64tooBlob(t,e){const s=atob(t),n=new ArrayBuffer(s.length),o=new Uint8Array(n);for(let t=0;t<s.length;t++)o[t]=s.charCodeAt(t);return new Blob([o],{type:e})}function findFile(t,e){const s=t=>t.replace(/^\/+/,"").replace(/\\/g,"/"),n=s(e);if(t[e])return{data:t[e],path:e};if(t[n])return{data:t[n],path:n};for(const e in t){const o=s(e);if(o===n)return{data:t[e],path:e};if(o===n+"/"||o+"/"===n)return{data:t[e],path:e}}const o=n.split("/").pop();if(o)for(const e in t){const a=s(e);if(a.split("/").pop()===o&&(a.endsWith(n)||n.endsWith(a)))return{data:t[e],path:e}}const a=n.toLowerCase();for(const e in t){if(s(e).toLowerCase()===a)return{data:t[e],path:e}}return null}self.addEventListener("fetch",(t=>{const e=new URL(t.request.url).pathname.match(/^\/game\/([^\/]+)\/(.+)$/);if("OPTIONS"!==t.request.method){if(e){const s=e[1],n=e[2];t.respondWith((async()=>{try{const t=await getGms(s);if(!t||!t.files)return new Response("game not found",{status:404});const e=findFile(t.files,n);if(!e)return new Response("couldnt find file: "+n,{status:404});const o=e.data;let a,r,i;if("object"==typeof o&&void 0!==o.content)a=o.content,r=o.mime||o.mimeType||"application/octet-stream",i=void 0!==o.binary?o.binary:o.isBinary;else{a=o;const t=e.path.split(".").pop().toLowerCase();r={html:"text/html",css:"text/css",js:"application/javascript",json:"application/json",png:"image/png",jpg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",woff:"font/woff",woff2:"font/woff2",ttf:"font/ttf",wasm:"application/wasm",txt:"text/plain",xml:"application/xml",webp:"image/webp",mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav"}[t]||"application/octet-stream";i=!new Set(["html","htm","css","js","mjs","json","xml","txt","md","csv","svg"]).has(t)}const c=new Headers({"Content-Type":r+(i?"":"; charset=utf-8"),"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, OPTIONS","Access-Control-Allow-Headers":"*","Cache-Control":"no-cache, no-store, must-revalidate","X-Content-Type-Options":"nosniff"}),l=i?b64tooBlob(a,r):a;return new Response(l,{status:200,statusText:"OK",headers:c})}catch(t){return new Response("err: "+t.message,{status:500})}})())}}else t.respondWith(new Response(null,{status:200,headers:new Headers({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, OPTIONS","Access-Control-Allow-Headers":"*","Access-Control-Max-Age":"86400"})}))})),self.addEventListener("install",(t=>{t.waitUntil(self.skipWaiting())})),self.addEventListener("activate",(t=>{t.waitUntil(clients.claim())})),self.addEventListener("message",(t=>{t.data&&"SKIP_WAITING"===t.data.type&&self.skipWaiting(),t.data&&"CLEAR_CACHE"===t.data.type&&(gmCcahe.clear(),t.ports[0].postMessage({success:!0}))}));